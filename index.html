<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>个人网址导航 - BieKuai</title>
    
    <!-- 添加红B绿K的BK图标 -->
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjRkZGRkZGIi8+Cjx0ZXh0IHg9IjgiIHk9IjQ4IiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iNDAiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjRkYwMDAwIj5CPC90ZXh0Pgo8dGV4dCB4PSIzMiIgeT0iNDgiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI0MCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiMwMDhFMzgiPks8L3RleHQ+Cjwvc3ZnPg==" type="image/svg+xml">
    
    <style>
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
            min-height: 100vh;
            line-height: 1.5;
        }

        /* 侧边栏样式 */
        .sidebar {
            width: 100%;
            max-width: 250px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            position: sticky;
            top: 0.5rem;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.625rem;
        }

        .sidebar h3 {
            margin: 0;
            color: #333;
            font-size: 1.125rem;
        }

        .toggle-sidebar {
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            color: #007bff;
        }

        .sidebar ul {
            list-style: none;
            padding: 0.625rem;
            display: none; /* 默认隐藏 */
        }

        .sidebar.expanded ul {
            display: block; /* 展开时显示 */
        }

        .sidebar li {
            padding: 0.5rem 0.625rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .sidebar li:hover {
            background: #f0f0f0;
        }

        .sidebar ul ul {
            margin-left: 0.9375rem;
        }

        /* 内容区域样式 */
        .content {
            flex: 1;
            max-width: 100%;
        }

        .content h1 {
            color: #222;
            font-size: 1.5rem;
            margin-bottom: 0.625rem;
            display: inline-block;
        }

        #toggle-mode {
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 4px;
            background: #17a2b8;
            color: white;
            cursor: pointer;
            transition: background 0.2s;
        }

        #toggle-mode:hover {
            background: #138496;
        }

        .save-btn, .restore-btn, .update-btn {
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 4px;
            background: #ffc107;
            color: white;
            cursor: pointer;
            transition: background 0.2s;
        }

        .save-btn:hover, .restore-btn:hover, .update-btn:hover {
            background: #e0a800;
        }

        #data-file {
            display: none;
        }

        #update-file-input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            max-width: 200px;
        }

        #credit-text {
            font-size: 0.875rem;
            color: #666;
            margin-top: 0.625rem;
            text-align: right;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.625rem;
            margin-bottom: 1.25rem;
        }

        .category {
            background: #fff;
            border: 1px solid #ddd;
            padding: 0.9375rem;
            margin-bottom: 0.9375rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .subcategory {
            margin: 0.625rem 0 0.625rem 1.25rem;
            padding: 0.625rem;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 5px;
        }

        .urls {
            margin: 0.3125rem 0 0.3125rem 1.25rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.625rem;
        }

        .url {
            padding: 0.25rem;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            min-height: 60px;
        }

        .url img {
            width: 100%;
            height: auto;
            max-height: 34px;
            object-fit: contain;
            margin: 0.375rem 0.0625rem 0.125rem 0.125rem;
        }

        .url-icon-link {
            width: 50%;
            display: block;
        }

        .url-content {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
            width: 50%;
            padding-right: 0.1875rem;
        }

        .url-main {
            display: flex;
            align-items: flex-start;
            gap: 0.0625rem;
            width: 100%;
        }

        .url-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3125rem;
            margin: 0.3125rem 0 0.3125rem 0.125rem;
        }

        .url-name {
            color: #007bff;
            font-weight: bold;
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .url-desc {
            color: #666;
            font-size: 0.75rem;
            line-height: 1.2;
            max-height: 2.4em;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        input, textarea {
            width: 100%;
            padding: 0.3125rem;
            margin: 0.3125rem 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 0.875rem;
        }

        textarea {
            height: 60px;
            resize: vertical;
        }

        button {
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.875rem;
        }

        .add-btn {
            background: #28a745;
            color: white;
        }

        .add-btn:hover {
            background: #218838;
        }

        .edit-btn {
            background: #007bff;
            color: white;
        }

        .edit-btn:hover {
            background: #0056b3;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
        }

        .delete-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .move-btn {
            background: #6c757d;
            color: white;
            padding: 0.5rem;
            font-size: 0.75rem;
        }

        .move-btn:hover {
            background: #5a6268;
        }

        .move-btn:disabled {
            background: #adb5bd;
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }

        /* 响应式设计 */
        @media (min-width: 768px) {
            body {
                flex-direction: row;
                padding: 1rem;
            }

            .sidebar {
                width: 200px;
                margin-right: 0.5rem;
                margin-bottom: 0;
            }

            .sidebar ul {
                display: block; /* 桌面端默认展开 */
            }

            .toggle-sidebar {
                display: none; /* 桌面端隐藏展开/收缩按钮 */
            }

            .content {
                max-width: 1000px;
            }

            .urls {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }

        @media (max-width: 767px) {
            .sidebar {
                max-width: 100%; /* 减少右侧留白 */
                margin-right: 0;
            }

            .urls {
                grid-template-columns: repeat(2, 1fr); /* 一行显示两个网址 */
                gap: 0.5rem;
            }

            #credit-text {
                position: static;
                margin-top: 0.625rem;
                text-align: right;
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .urls {
                grid-template-columns: repeat(2, 1fr); /* 小屏幕仍保持一行两个 */
            }

            button {
                width: 100%;
                text-align: center;
            }

            .url-actions {
                flex-direction: column;
                width: 100%;
            }

            .url-actions button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>分类导航</h3>
            <button class="toggle-sidebar" onclick="toggleSidebar()">展开</button>
        </div>
        <ul id="nav"></ul>
    </div>

    <div class="content">
        <h1>个人网址导航 - BieKuai</h1>
        <div class="button-group">
            <button id="toggle-mode" onclick="toggleMode()">进入</button>
            <button class="save-btn hidden" onclick="saveData()">保存备份</button>
            <button class="restore-btn hidden" onclick="document.getElementById('data-file').click()">还原备份</button>
            <input type="file" id="data-file" accept=".json">
            <input type="text" id="update-file-input" class="hidden" placeholder="输入备份文件名">
            <button class="update-btn hidden" onclick="updateOnline()">在线更新</button>
            <span id="credit-text" class="hidden">创意制作 u788990@163.com</span>
        </div>
        <div id="categories"></div>
        <button class="add-btn hidden" onclick="addCategory()">添加分类</button>
    </div>

    <script>
        const defaultCategories = [
            {
                id: 'cat1',
                name: '常用网站',
                isEditing: false,
                urls: [
                    { id: 'url1', name: 'Google', url: 'https://www.google.com', desc: '全球搜索引擎', icon: 'https://www.google.com/favicon.ico', isEditing: false },
                    { id: 'url2', name: 'GitHub', url: 'https://github.com', desc: '代码托管平台', icon: 'https://github.com/favicon.ico', isEditing: false }
                ],
                subcategories: []
            },
            {
                id: 'cat2',
                name: '学习资源',
                isEditing: false,
                urls: [],
                subcategories: [
                    {
                        id: 'subcat1',
                        name: '编程教程',
                        isEditing: false,
                        urls: [
                            { id: 'url3', name: 'MDN', url: 'https://developer.mozilla.org', desc: 'Web开发文档', icon: 'https://developer.mozilla.org/favicon.ico', isEditing: false }
                        ]
                    }
                ]
            }
        ];

        const fileName = window.location.pathname.split('/').pop().replace(/\.[^/.]+$/, '') || 'index';
        const storageKey = `webstack-${fileName}`;

        let categories = loadCategories();
        let isEditMode = false;
        let isDataSaved = true;
        let backupFiles = [];
        let isSidebarExpanded = false;

        function loadCategories() {
            try {
                const saved = localStorage.getItem(storageKey);
                return saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(defaultCategories));
            } catch (e) {
                console.error('LoadCategories Error:', e);
                return JSON.parse(JSON.stringify(defaultCategories));
            }
        }

        function saveCategories() {
            try {
                localStorage.setItem(storageKey, JSON.stringify(categories));
            } catch (e) {
                console.error('SaveCategories Error:', e);
                alert('无法保存数据，可能是存储空间不足或浏览器设置限制。');
            }
        }

        document.getElementById('data-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    categories = JSON.parse(event.target.result);
                    isDataSaved = false;
                    saveCategories();
                    renderCategories();
                    alert('数据已从备份还原！');
                } catch (err) {
                    console.error('Load Error:', err);
                    alert('加载失败，无效的JSON文件。');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        function updateOnline() {
            try {
                let filename = document.getElementById('update-file-input').value.trim();
                if (!filename) {
                    alert('请输入文件名！');
                    return;
                }
                if (!filename.endsWith('.json')) {
                    filename += '.json';
                }
                fetch(`./${filename}`)
                    .then(response => {
                        if (!response.ok) throw new Error('File not found');
                        return response.text();
                    })
                    .then(data => {
                        try {
                            categories = JSON.parse(data);
                            isDataSaved = false;
                            saveCategories();
                            renderCategories();
                            alert('成功还原！');
                        } catch (err) {
                            console.error('Parse Error:', err);
                            alert('加载失败，无效的JSON文件。');
                        }
                    })
                    .catch(err => {
                        console.error('Fetch Error:', err);
                        alert('没有文件！');
                    });
            } catch (e) {
                console.error('UpdateOnline Error:', e);
                alert('在线更新失败，请检查控制台！');
            }
        }

        function generateBackupFilename() {
            const now = new Date();
            const timestamp = `${now.getFullYear()}${padZero(now.getMonth() + 1)}${padZero(now.getDate())}-${padZero(now.getHours())}${padZero(now.getMinutes())}${padZero(now.getSeconds())}`;
            let filename = `backup-${timestamp}.json`;
            let counter = 1;
            while (backupFiles.includes(filename)) {
                filename = `backup-${timestamp}-${counter}.json`;
                counter++;
            }
            backupFiles.push(filename);
            return filename;
        }

        function padZero(num) {
            return num < 10 ? `0${num}` : num;
        }

        function saveData() {
            try {
                const dataStr = JSON.stringify(categories, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const filename = generateBackupFilename();
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                isDataSaved = true;
                saveCategories();
                alert(`数据已保存为 ${filename}！请保存到 HTML 文件目录。`);
            } catch (e) {
                console.error('SaveData Error:', e);
                alert('保存备份失败，请检查控制台！');
            }
        }

        function getFaviconUrl(url) {
            try {
                const urlObj = new URL(url);
                return `${urlObj.origin}/favicon.ico`;
            } catch (e) {
                console.error('Invalid URL for favicon:', url, e);
                return 'https://example.com/favicon.ico';
            }
        }

        function moveCategory(id, direction) {
            try {
                const index = categories.findIndex(c => c.id === id);
                if (index === -1) return;
                if (direction === 'up' && index > 0) {
                    [categories[index], categories[index - 1]] = [categories[index - 1], categories[index]];
                } else if (direction === 'down' && index < categories.length - 1) {
                    [categories[index], categories[index + 1]] = [categories[index + 1], categories[index]];
                } else {
                    return;
                }
                isDataSaved = false;
                saveCategories();
                renderCategories();
            } catch (e) {
                console.error('MoveCategory Error:', e);
            }
        }

        function moveSubcategory(catId, subcatId, direction) {
            try {
                const cat = categories.find(c => c.id === catId);
                if (!cat) return;
                const subcats = cat.subcategories;
                const index = subcats.findIndex(s => s.id === subcatId);
                if (index === -1) return;
                if (direction === 'up' && index > 0) {
                    [subcats[index], subcats[index - 1]] = [subcats[index - 1], subcats[index]];
                } else if (direction === 'down' && index < subcats.length - 1) {
                    [subcats[index], subcats[index + 1]] = [subcats[index + 1], subcats[index]];
                } else {
                    return;
                }
                isDataSaved = false;
                saveCategories();
                renderCategories();
            } catch (e) {
                console.error('MoveSubcategory Error:', e);
            }
        }

        function moveUrl(id, direction) {
            try {
                for (const cat of categories) {
                    const urlIndex = cat.urls.findIndex(u => u.id === id);
                    if (urlIndex !== -1) {
                        if (direction === 'up' && urlIndex > 0) {
                            [cat.urls[urlIndex], cat.urls[urlIndex - 1]] = [cat.urls[urlIndex - 1], cat.urls[urlIndex]];
                        } else if (direction === 'down' && urlIndex < cat.urls.length - 1) {
                            [cat.urls[urlIndex], cat.urls[urlIndex + 1]] = [cat.urls[urlIndex + 1], cat.urls[urlIndex]];
                        } else {
                            return;
                        }
                        isDataSaved = false;
                        saveCategories();
                        renderCategories();
                        return;
                    }
                    for (const subcat of cat.subcategories) {
                        const subUrlIndex = subcat.urls.findIndex(u => u.id === id);
                        if (subUrlIndex !== -1) {
                            if (direction === 'up' && subUrlIndex > 0) {
                                [subcat.urls[subUrlIndex], subcat.urls[subUrlIndex - 1]] = [subcat.urls[subUrlIndex - 1], subcat.urls[subUrlIndex]];
                            } else if (direction === 'down' && subUrlIndex < subcat.urls.length - 1) {
                                [subcat.urls[subUrlIndex], subcat.urls[subUrlIndex + 1]] = [subcat.urls[subUrlIndex + 1], subcat.urls[subUrlIndex]];
                            } else {
                                return;
                            }
                            isDataSaved = false;
                            saveCategories();
                            renderCategories();
                            return;
                        }
                    }
                }
            } catch (e) {
                console.error('MoveUrl Error:', e);
            }
        }

        function renderNav() {
            try {
                const nav = document.getElementById('nav');
                if (!nav) throw new Error('Nav element not found');
                nav.innerHTML = '';
                categories.forEach(cat => {
                    const li = document.createElement('li');
                    li.textContent = cat.name;
                    li.onclick = () => {
                        const target = document.getElementById(cat.id);
                        if (target) target.scrollIntoView({ behavior: 'smooth' });
                    };
                    nav.appendChild(li);

                    if (cat.subcategories.length) {
                        const subUl = document.createElement('ul');
                        cat.subcategories.forEach(subcat => {
                            const subLi = document.createElement('li');
                            subLi.textContent = subcat.name;
                            subLi.onclick = () => {
                                const target = document.getElementById(subcat.id);
                                if (target) target.scrollIntoView({ behavior: 'smooth' });
                            };
                            subUl.appendChild(subLi);
                        });
                        nav.appendChild(subUl);
                    }
                });
            } catch (e) {
                console.error('RenderNav Error:', e);
            }
        }

        function renderCategories() {
            try {
                const container = document.getElementById('categories');
                if (!container) throw new Error('Categories container not found');
                container.innerHTML = '';
                categories.forEach((cat, catIndex) => {
                    const catDiv = document.createElement('div');
                    catDiv.className = 'category';
                    catDiv.id = cat.id;
                    catDiv.innerHTML = `
                        <h2>${cat.isEditing ? `<input value="${cat.name}" id="cat-name-${cat.id}" placeholder="分类名称">` : cat.name}</h2>
                        <button class="edit-btn ${isEditMode ? '' : 'hidden'}" onclick="toggleEditCategory('${cat.id}')">${cat.isEditing ? '保存' : '修改'}</button>
                        <button class="delete-btn ${isEditMode ? '' : 'hidden'} ${cat.isEditing ? '' : 'disabled'}" onclick="deleteCategory('${cat.id}')">删除</button>
                        <button class="move-btn ${isEditMode ? '' : 'hidden'}" onclick="moveCategory('${cat.id}', 'up')" ${catIndex === 0 ? 'disabled' : ''}>上移</button>
                        <button class="move-btn ${isEditMode ? '' : 'hidden'}" onclick="moveCategory('${cat.id}', 'down')" ${catIndex === categories.length - 1 ? 'disabled' : ''}>下移</button>
                        <div class="urls" id="urls-${cat.id}"></div>
                        <button class="add-btn ${isEditMode ? '' : 'hidden'}" onclick="addUrl('${cat.id}')">添加网址</button>
                        <div id="subcats-${cat.id}"></div>
                        <button class="add-btn ${isEditMode ? '' : 'hidden'}" onclick="addSubcategory('${cat.id}')">添加子分类</button>
                    `;
                    container.appendChild(catDiv);

                    const urlsDiv = catDiv.querySelector(`#urls-${cat.id}`);
                    cat.urls.forEach((url, urlIndex) => {
                        const urlDiv = document.createElement('div');
                        urlDiv.className = 'url';
                        urlDiv.innerHTML = `
                            ${url.isEditing ? `
                                <div class="url-main">
                                    <div>
                                        <input value="${url.name}" id="url-name-${url.id}" placeholder="名称">
                                        <input value="${url.url}" id="url-url-${url.id}" placeholder="网址">
                                        <textarea id="url-desc-${url.id}" placeholder="描述">${url.desc}</textarea>
                                    </div>
                                </div>
                            ` : `
                                <div class="url-main">
                                    <a href="${url.url}" target="_blank" class="url-icon-link">
                                        <img src="${url.icon}" alt="favicon" loading="lazy" onerror="this.src='https://example.com/favicon.ico'">
                                    </a>
                                    <div class="url-content">
                                        <div class="url-name">${url.name}</div>
                                        <div class="url-desc">${url.desc}</div>
                                    </div>
                                </div>
                            `}
                            <div class="url-actions ${isEditMode ? '' : 'hidden'}">
                                <button class="edit-btn" onclick="toggleEditUrl('${url.id}')">${url.isEditing ? '保存' : '修改'}</button>
                                <button class="delete-btn ${url.isEditing ? '' : 'disabled'}" onclick="deleteUrl('${url.id}')">删除</button>
                                <button class="move-btn" onclick="moveUrl('${url.id}', 'up')" ${urlIndex === 0 ? 'disabled' : ''}>上移</button>
                                <button class="move-btn" onclick="moveUrl('${url.id}', 'down')" ${urlIndex === cat.urls.length - 1 ? 'disabled' : ''}>下移</button>
                            </div>
                        `;
                        urlsDiv.appendChild(urlDiv);
                    });

                    const subcatsDiv = catDiv.querySelector(`#subcats-${cat.id}`);
                    cat.subcategories.forEach((subcat, subcatIndex) => {
                        const subcatDiv = document.createElement('div');
                        subcatDiv.className = 'subcategory';
                        subcatDiv.id = subcat.id;
                        subcatDiv.innerHTML = `
                            <h4>${subcat.isEditing ? `<input value="${subcat.name}" id="subcat-name-${subcat.id}" placeholder="子分类名称">` : subcat.name}</h4>
                            <button class="edit-btn ${isEditMode ? '' : 'hidden'}" onclick="toggleEditSubcategory('${subcat.id}')">${subcat.isEditing ? '保存' : '修改'}</button>
                            <button class="delete-btn ${isEditMode ? '' : 'hidden'} ${subcat.isEditing ? '' : 'disabled'}" onclick="deleteSubcategory('${subcat.id}')">删除</button>
                            <button class="move-btn ${isEditMode ? '' : 'hidden'}" onclick="moveSubcategory('${cat.id}', '${subcat.id}', 'up')" ${subcatIndex === 0 ? 'disabled' : ''}>上移</button>
                            <button class="move-btn ${isEditMode ? '' : 'hidden'}" onclick="moveSubcategory('${cat.id}', '${subcat.id}', 'down')" ${sub  : ''}>下移</button>
                            <div class="urls" id="suburls-${subcat.id}"></div>
                            <button class="add-btn ${isEditMode ? '' : 'hidden'}" onclick="addSubUrl('${subcat.id}')">添加网址</button>
                        `;
                        subcatsDiv.appendChild(subcatDiv);

                        const subUrlsDiv = subcatDiv.querySelector(`#suburls-${subcat.id}`);
                        subcat.urls.forEach((url, urlIndex) => {
                            const urlDiv = document.createElement('div');
                            urlDiv.className = 'url';
                            urlDiv.innerHTML = `
                                ${url.isEditing ? `
                                    <div class="url-main">
                                        <div>
                                            <input value="${url.name}" id="url-name-${url.id}" placeholder="名称">
                                            <input value="${url.url}" id="url-url-${url.id}" placeholder="网址">
                                            <textarea id="url-desc-${url.id}" placeholder="描述">${url.desc}</textarea>
                                        </div>
                                    </div>
                                ` : `
                                    <div class="url-main">
                                        <a href="${url.url}" target="_blank" class="url-icon-link">
                                            <img src="${url.icon}" alt="favicon" loading="lazy" onerror="this.src='https://example.com/favicon.ico'">
                                        </a>
                                        <div class="url-content">
                                            <div class="url-name">${url.name}</div>
                                            <div class="url-desc">${url.desc}</div>
                                        </div>
                                    </div>
                                `}
                                <div class="url-actions ${isEditMode ? '' : 'hidden'}">
                                    <button class="edit-btn" onclick="toggleEditUrl('${url.id}')">${url.isEditing ? '保存' : '修改'}</button>
                                    <button class="delete-btn ${url.isEditing ? '' : 'disabled'}" onclick="deleteUrl('${url.id}')">删除</button>
                                    <button class="move-btn" onclick="moveUrl('${url.id}', 'up')" ${urlIndex === 0 ? 'disabled' : ''}>上移</button>
                                    <button class="move-btn" onclick="moveUrl('${url.id}', 'down')" ${urlIndex === subcat.urls.length - 1 ? 'disabled' : ''}>下移</button>
                                </div>
                            `;
                            subUrlsDiv.appendChild(urlDiv);
                        });
                    });

                    if (cat.isEditing) {
                        catDiv.querySelector(`#cat-name-${cat.id}`).oninput = e => {
                            cat.name = e.target.value;
                            isDataSaved = false;
                        };
                    }
                });

                const globalAddBtn = document.querySelector('.content > .add-btn');
                if (globalAddBtn) globalAddBtn.className = `add-btn ${isEditMode ? '' : 'hidden'}`;
                const saveBtn = document.querySelector('.save-btn');
                if (saveBtn) saveBtn.className = `save-btn ${isEditMode ? '' : 'hidden'}`;
                const restoreBtn = document.querySelector('.restore-btn');
                if (restoreBtn) restoreBtn.className = `restore-btn ${isEditMode ? '' : 'hidden'}`;
                const updateInput = document.getElementById('update-file-input');
                if (updateInput) updateInput.className = `${isEditMode ? '' : 'hidden'}`;
                const updateBtn = document.querySelector('.update-btn');
                if (updateBtn) updateBtn.className = `update-btn ${isEditMode ? '' : 'hidden'}`;
                const creditText = document.getElementById('credit-text');
                if (creditText) creditText.className = `${isEditMode ? '' : 'hidden'}`;

                renderNav();
            } catch (e) {
                console.error('RenderCategories Error:', e);
            }
        }

        function toggleMode() {
            try {
                if (isEditMode) {
                    let hasEditing = false;
                    for (const cat of categories) {
                        if (cat.isEditing) {
                            hasEditing = true;
                            break;
                        }
                        if (cat.urls.some(url => url.isEditing)) {
                            hasEditing = true;
                            break;
                        }
                        if (cat.subcategories.some(subcat => subcat.isEditing || subcat.urls.some(url => url.isEditing))) {
                            hasEditing = true;
                            break;
                        }
                    }
                    if (hasEditing) {
                        alert('退出失败，请先完成编辑！');
                        return;
                    }
                    if (!isDataSaved) {
                        alert('数据未保存，请点击“保存备份”后再退出！');
                        return;
                    }
                    isEditMode = false;
                } else {
                    isEditMode = true;
                }
                const toggleBtn = document.getElementById('toggle-mode');
                if (toggleBtn) toggleBtn.textContent = isEditMode ? '退出' : '进入';
                renderCategories();
            } catch (e) {
                console.error('ToggleMode Error:', e);
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.querySelector('.toggle-sidebar');
            isSidebarExpanded = !isSidebarExpanded;
            sidebar.classList.toggle('expanded', isSidebarExpanded);
            toggleBtn.textContent = isSidebarExpanded ? '收缩' : '展开';
        }

        function generateId(prefix) {
            return `${prefix}-${Date.now()}-${Math.random().toString(36).slice(2, 9)}`;
        }

        function addCategory() {
            try {
                categories.push({
                    id: generateId('cat'),
                    name: '新分类',
                    isEditing: false,
                    urls: [],
                    subcategories: []
                });
                isDataSaved = false;
                saveCategories();
                renderCategories();
            } catch (e) {
                console.error('AddCategory Error:', e);
                alert('添加分类失败，请检查控制台！');
            }
        }

        function toggleEditCategory(id) {
            try {
                const cat = categories.find(c => c.id === id);
                if (!cat) return;
                if (cat.isEditing) {
                    const nameInput = document.getElementById(`cat-name-${id}`);
                    if (nameInput) cat.name = nameInput.value;
                }
                cat.isEditing = !cat.isEditing;
                isDataSaved = false;
                saveCategories();
                renderCategories();
            } catch (e) {
                console.error('ToggleEditCategory Error:', e);
            }
        }

        function deleteCategory(id) {
            try {
                const cat = categories.find(c => c.id === id);
                if (!cat || !cat.isEditing) return;
                categories = categories.filter(c => c.id !== id);
                isDataSaved = false;
                saveCategories();
                renderCategories();
            } catch (e) {
                console.error('DeleteCategory Error:', e);
            }
        }

        function addUrl(catId) {
            try {
                const cat = categories.find(c => c.id === catId);
                if (!cat) return;
                const newUrl = {
                    id: generateId('url'),
                    name: '新网站',
                    url: 'https://example.com',
                    desc: '网站描述',
                    icon: getFaviconUrl('https://example.com'),
                    isEditing: true
                };
                cat.urls.push(newUrl);
                isDataSaved = false;
                saveCategories();
                renderCategories();
            } catch (e) {
                console.error('AddUrl Error:', e);
            }
        }

        function toggleEditUrl(id) {
            try {
                let url;
                for (const cat of categories) {
                    url = cat.urls.find(u => u.id === id);
                    if (url) break;
                    for (const subcat of cat.subcategories) {
                        url = subcat.urls.find(u => u.id === id);
                        if (url) break;
                    }
                    if (url) break;
                }
                if (!url) return;
                if (url.isEditing) {
                    const nameInput = document.getElementById(`url-name-${id}`);
                    const urlInput = document.getElementById(`url-url-${id}`);
                    const descInput = document.getElementById(`url-desc-${id}`);
                    if (nameInput && urlInput && descInput) {
                        url.name = nameInput.value;
                        url.url = urlInput.value;
                        url.desc = descInput.value;
                        url.icon = getFaviconUrl(urlInput.value);
                    }
                }
                url.isEditing = !url.isEditing;
                isDataSaved = false;
                saveCategories();
                renderCategories();
            } catch (e) {
                console.error('ToggleEditUrl Error:', e);
            }
        }

        function deleteUrl(id) {
            try {
                for (const cat of categories) {
                    const urlIndex = cat.urls.findIndex(u => u.id === id);
                    if (urlIndex !== -1 && cat.urls[urlIndex].isEditing) {
                        cat.urls.splice(urlIndex, 1);
                        isDataSaved = false;
                        saveCategories();
                        renderCategories();
                        return;
                    }
                    for (const subcat of cat.subcategories) {
                        const subUrlIndex = subcat.urls.findIndex(u => u.id === id);
                        if (subUrlIndex !== -1 && subcat.urls[subUrlIndex].isEditing) {
                            subcat.urls.splice(subUrlIndex, 1);
                            isDataSaved = false;
                            saveCategories();
                            renderCategories();
                            return;
                        }
                    }
                }
            } catch (e) {
                console.error('DeleteUrl Error:', e);
            }
        }

        function addSubcategory(catId) {
            try {
                const cat = categories.find(c => c.id === catId);
                if (!cat) return;
                cat.subcategories.push({
                    id: generateId('subcat'),
                    name: '新子分类',
                    isEditing: false,
                    urls: []
                });
                isDataSaved = false;
                saveCategories();
                renderCategories();
            } catch (e) {
                console.error('AddSubcategory Error:', e);
            }
        }

        function toggleEditSubcategory(id) {
            try {
                let subcat;
                for (const cat of categories) {
                    subcat = cat.subcategories.find(s => s.id === id);
                    if (subcat) break;
                }
                if (!subcat) return;
                if (subcat.isEditing) {
                    const nameInput = document.getElementById(`subcat-name-${id}`);
                    if (nameInput) subcat.name = nameInput.value;
                }
                subcat.isEditing = !subcat.isEditing;
                isDataSaved = false;
                saveCategories();
                renderCategories();
            } catch (e) {
                console.error('ToggleEditSubcategory Error:', e);
            }
        }

        function deleteSubcategory(id) {
            try {
                for (const cat of categories) {
                    const subcatIndex = cat.subcategories.findIndex(s => s.id === id);
                    if (subcatIndex !== -1 && cat.subcategories[subcatIndex].isEditing) {
                        cat.subcategories.splice(subcatIndex, 1);
                        isDataSaved = false;
                        saveCategories();
                        renderCategories();
                        return;
                    }
                }
            } catch (e) {
                console.error('DeleteSubcategory Error:', e);
            }
        }

        function addSubUrl(subcatId) {
            try {
                let subcat;
                for (const cat of categories) {
                    subcat = cat.subcategories.find(s => s.id === subcatId);
                    if (subcat) break;
                }
                if (!subcat) return;
                const newUrl = {
                    id: generateId('url'),
                    name: '新网站',
                    url: 'https://example.com',
                    desc: '网站描述',
                    icon: getFaviconUrl('https://example.com'),
                    isEditing: true
                };
                subcat.urls.push(newUrl);
                isDataSaved = false;
                saveCategories();
                renderCategories();
            } catch (e) {
                console.error('AddSubUrl Error:', e);
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        window.addEventListener('resize', debounce(() => {
            renderCategories();
        }, 200));

        try {
            console.log('Script loaded');
            renderCategories();
        } catch (e) {
            console.error('Initial render failed:', e);
        }
    </script>
</body>
</html>