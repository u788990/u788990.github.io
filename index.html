<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>个人网址导航 - BieKuai</title>
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjRkZGRkZGIi8+Cjx0ZXh0IHg9IjgiIHk9IjQ4IiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iNDAiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjRkYwMDAwIj5CPC90ZXh0Pgo8dGV4dCB4PSIzMiIgeT0iNDgiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI0MCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiMwMDhFMzgiPks8L3RleHQ+Cjwvc3ZnPg==" type="image/svg+xml">
    <style>
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
            min-height: 100vh;
            line-height: 1.5;
        }
        .sidebar {
            width: 100%;
            max-width: 250px;
            background: transparent;
            border: none;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
        }
        .sidebar-header {
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        .sidebar h3 {
            margin: 0;
            color: #ff69b4;
            font-size: 1.35rem;
            font-weight: bold;
        }
        .toggle-sidebar {
            display: block;
            width: 100%;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #ff69b4;
            text-align: center;
            padding: 0.5rem 0;
        }
        .sidebar ul {
            list-style: none;
            padding: 0.5rem;
            display: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-top: 0.5rem;
            max-height: 80vh;
            overflow-y: auto;
        }
        .sidebar.expanded ul {
            display: block;
        }
        .sidebar li {
            padding: 0.5rem 0.625rem;
            cursor: pointer;
            transition: background 0.2s;
            color: #ff69b4;
            font-weight: bold;
            font-size: 0.875rem;
        }
        .sidebar li:hover {
            background: rgba(0, 0, 0, 0.1);
        }
        .content {
            flex: 1;
            max-width: 100%;
            margin-top: 6rem;
        }
        .content h1 {
            color: #222;
            font-size: 1.8rem;
            margin-bottom: 0.625rem;
            display: inline-block;
        }
        #toggle-mode {
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 4px;
            background: #17a2b8;
            color: white;
            cursor: pointer;
            transition: background 0.2s;
            float: right;
        }
        #toggle-mode:hover {
            background: #138496;
        }
        .save-btn, .restore-btn, .update-btn, .download-btn {
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 4px;
            background: #ffc107;
            color: white;
            cursor: pointer;
            transition: background 0.2s;
        }
        .save-btn:hover, .restore-btn:hover, .update-btn:hover, .download-btn:hover {
            background: #e0a800;
        }
        .save-btn.blink {
            animation: blink 0.6s ease-in-out 3; /* 闪烁3次，每次0.6秒 */
        }
        @keyframes blink {
            0%, 100% {
                background: #ffc107;
            }
            50% {
                background: #ffeb3b;
            }
        }
        #data-file {
            display: none;
        }
        #update-file-input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            max-width: 200px;
            font-size: 0.875rem;
        }
        #credit-text {
            font-size: 0.875rem;
            margin-top: 0.5rem;
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            clear: both;
            gap: 10px;
            flex-wrap: wrap;
        }
        #credit-text .text-part {
            background: #008E38;
            color: #FFFFFF;
            font-size: 1.14rem;
            padding: 8px 10px;
            height: 39px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            border-radius: 4px;
            font-family: Arial, 'Microsoft YaHei', sans-serif;
        }
        #credit-text img {
            height: 39px;
            vertical-align: middle;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.625rem;
            margin-bottom: 1.25rem;
            align-items: center;
        }
        .category {
            background: #fff;
            border: 1px solid #ddd;
            padding: 0.9375rem;
            margin-bottom: 0.9375rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .subcategory {
            margin: 0.625rem 0 0.625rem 1.25rem;
            padding: 0.625rem;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        .urls {
            margin: 0.3125rem 0 0.3125rem 1.25rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.625rem;
        }
        .url {
            padding: 0.25rem;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            min-height: 60px;
        }
        .url img {
            width: 100%;
            height: auto;
            max-height: 34px;
            object-fit: contain;
            margin: 0.375rem 0.0625rem 0.125rem 0.125rem;
        }
        .url-icon-link {
            width: 50%;
            display: block;
        }
        .url-content {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
            width: 50%;
            padding-right: 0.1875rem;
        }
        .url-main {
            display: flex;
            align-items: flex-start;
            width: 100%;
        }
        .url-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3125rem;
            margin: 0.3125rem 0 0.3125rem 0.125rem;
        }
        .url-name {
            color: #007bff;
            font-weight: bold;
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }
        .url-desc {
            color: #666;
            font-size: 0.75rem;
            line-height: 1.2;
            max-height: 2.4em;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        input, textarea, select {
            width: 100%;
            padding: 0.3125rem;
            margin: 0.3125rem 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 0.875rem;
            min-height: 36px;
        }
        textarea {
            height: 60px;
            resize: vertical;
        }
        button {
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.875rem;
        }
        .add-btn {
            background: #28a745;
            color: white;
        }
        .add-btn:hover {
            background: #218838;
        }
        .edit-btn {
            background: #007bff;
            color: white;
        }
        .edit-btn:hover {
            background: #0056b3;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
        }
        .delete-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .move-btn, .migrate-btn {
            background: #6c757d;
            color: white;
            padding: 0.5rem;
            font-size: 0.75rem;
        }
        .move-btn:hover, .migrate-btn:hover {
            background: #5a6268;
        }
        .move-btn:disabled, .migrate-btn:disabled {
            background: #adb5bd;
            cursor: not-allowed;
        }
        .hidden {
            display: none;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            pointer-events: auto;
        }
        .modal-content {
            background: #fff;
            padding: 1rem;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 2010;
        }
        .modal-content p {
            margin-bottom: 1rem;
            font-size: 1rem;
            color: #333;
        }
        .modal-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }
        .modal-actions button {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        .modal-confirm {
            background: #28a745;
            color: white;
        }
        .modal-confirm:hover {
            background: #218838;
        }
        .modal-cancel {
            background: #dc3545;
            color: white;
        }
        .modal-cancel:hover {
            background: #c82333;
        }
        @media (min-width: 768px) {
            body {
                flex-direction: row;
                padding: 1rem;
            }
            .sidebar {
                width: 200px;
                background: #fff;
                border: 1px solid #ddd;
                margin-right: 0.25rem;
            }
            .sidebar-header {
                background: transparent;
            }
            .sidebar ul {
                display: block;
                background: transparent;
            }
            .sidebar h3 {
                font-size: 1.55em;
            }
            .sidebar li {
                font-size: 1.45rem;
            }
            .toggle-sidebar {
                display: none;
            }
            .content {
                margin-left: 220px;
                margin-top: 0;
                max-width: calc(100% - 220px);
            }
            .content h1 {
                font-size: 1.8rem;
            }
            .urls {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
        @media (max-width: 767px) {
            .sidebar {
                max-width: 35%;
                margin-right: 0;
                padding: 0.5rem;
            }
            .sidebar.expanded ul {
                display: block;
            }
            .content {
                margin-left: 0;
                margin-top: 6rem;
            }
            .content h1 {
                font-size: 1.8rem;
            }
            .category h2 {
                font-size: 1.26rem;
            }
            .subcategory h4 {
                font-size: 0.98rem;
            }
            .url-name {
                font-size: 0.7rem;
            }
            .url-desc {
                font-size: 0.6rem;
            }
            .url img {
                max-height: 24px;
            }
            .urls {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 0.5rem;
            }
            #credit-text {
                margin-top: 0.5rem;
                margin-bottom: 1.25rem;
            }
            input, textarea {
                font-size: 1rem;
                min-height: 40px;
            }
        }
        @media (max-width: 480px) {
            .urls {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 0.3rem;
            }
            .url {
                padding: 0.2rem;
                min-height: 50px;
            }
            .url-name {
                font-size: 0.65rem;
                white-space: normal;
            }
            .url-desc {
                font-size: 0.55rem;
            }
            .url img {
                max-height: 22px;
            }
            button {
                width: 100%;
                text-align: center;
            }
            .url-actions {
                flex-direction: column;
                width: 100%;
            }
            .url-actions button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>分类导航</h3>
        </div>
        <ul id="nav"></ul>
        <button class="toggle-sidebar" onclick="toggleSidebar()">▼</button>
    </div>
    <div class="content">
        <div class="header-group">
            <h1>个人网址导航 - BieKuai</h1>
            <button id="toggle-mode" onclick="toggleMode()">进入</button>
        </div>
        <div id="credit-text">
            <span class="text-part">创意制作</span>
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjA4IiBoZWlnaHQ9IjM5IiB2aWV3Qm94PSIwIDAgMjA4IDM5IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxyZWN0IHdpZHRoPSIyMDgiIGhlaWdodD0iMzkiIGZpbGw9IiMwMDhFMzgiLz4KICA8dGV4dCB4PSIxMDQiIHk9IjI1IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwsIE1pY3Jvc29mdCBZYUhlaSwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyMCIgZm9udC13ZWlnaHQ9IjQwMCIgZmlsbD0iI0ZGRkZGRiI+dTc4ODk5MEAxNjMuY29tPC90ZXh0Pgo8L3N2Zz4=" alt="u788990@163.com">
            <button class="download-btn" onclick="downloadPage()">下载到本地应用</button>
        </div>
        <div class="button-group">
            <button class="save-btn hidden" onclick="saveData()">保存备份</button>
            <button class="restore-btn hidden" onclick="document.getElementById('data-file').click()">还原备份</button>
            <input type="file" id="data-file" accept=".json">
            <input type="text" id="update-file-input" class="hidden" placeholder="输入备份文件名">
            <button class="update-btn hidden" onclick="updateOnline()">在线更新</button>
        </div>
        <div id="categories"></div>
        <button class="add-btn hidden" onclick="addCategory()">添加分类</button>
    </div>
    <script>
        const defaultCategories = [
            {
                id: 'cat1',
                name: '常用网站',
                isEditing: false,
                urls: [
                    { id: 'url1', name: 'Google', url: 'https://www.google.com', desc: '全球搜索引擎', icon: 'https://www.google.com/favicon.ico', isEditing: false },
                    { id: 'url2', name: 'GitHub', url: 'https://github.com', desc: '代码托管平台', icon: 'https://github.com/favicon.ico', isEditing: false }
                ],
                subcategories: []
            },
            {
                id: 'cat2',
                name: '学习资源',
                isEditing: false,
                urls: [],
                subcategories: [
                    {
                        id: 'subcat1',
                        name: '编程教程',
                        isEditing: false,
                        urls: [
                            { id: 'url3', name: 'MDN', url: 'https://developer.mozilla.org', desc: 'Web开发文档', icon: 'https://developer.mozilla.org/favicon.ico', isEditing: false }
                        ]
                    }
                ]
            }
        ];
        const fileName = window.location.pathname.split('/').pop().replace(/\.[^/.]+$/, '') || 'index';
        const storageKey = `webstack-${fileName}`;
        let categories = loadCategories();
        let isEditMode = false;
        let isDataSaved = true;

        function loadCategories() {
            const saved = localStorage.getItem(storageKey);
            const loadedCategories = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(defaultCategories));
            loadedCategories.forEach(cat => {
                cat.isEditing = false;
                cat.urls.forEach(url => url.isEditing = false);
                cat.subcategories.forEach(subcat => {
                    subcat.isEditing = false;
                    subcat.urls.forEach(url => url.isEditing = false);
                });
            });
            return loadedCategories;
        }

        function saveCategories() {
            const categoriesToSave = JSON.parse(JSON.stringify(categories));
            categoriesToSave.forEach(cat => {
                cat.isEditing = false;
                cat.urls.forEach(url => url.isEditing = false);
                cat.subcategories.forEach(subcat => {
                    subcat.isEditing = false;
                    subcat.urls.forEach(url => url.isEditing = false);
                });
            });
            localStorage.setItem(storageKey, JSON.stringify(categoriesToSave));
        }

        function downloadPage() {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'BieKuai_Navigation.html';
            a.click();
            URL.revokeObjectURL(url);
            alert('网页已开始下载为 BieKuai_Navigation.html');
        }

        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 767;
        }

        function fixMobileKeyboard() {
            if (!isMobileDevice()) return;
            const inputs = document.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                input.removeEventListener('touchstart', handleTouchStart);
                input.removeEventListener('focus', handleFocus);
                input.removeEventListener('input', handleInput);
                input.setAttribute('autocapitalize', 'off');
                input.setAttribute('autocorrect', 'off');
                input.addEventListener('touchstart', handleTouchStart, { passive: false });
                input.addEventListener('focus', handleFocus);
                input.addEventListener('input', handleInput);
            });

            function handleTouchStart(e) {
                e.stopPropagation();
                const input = e.target;
                input.focus();
                // 手机端点击输入框时收缩侧边栏
                const sidebar = document.getElementById('sidebar');
                const toggleBtn = document.querySelector('.toggle-sidebar');
                if (sidebar.classList.contains('expanded')) {
                    sidebar.classList.remove('expanded');
                    toggleBtn.textContent = '▲';
                }
            }

            function handleFocus(e) {
                const input = e.target;
                setTimeout(() => {
                    input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            }

            function handleInput(e) {
                const input = e.target;
                input.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', () => {
                    const activeElement = document.activeElement;
                    if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
                        activeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }
        }

        document.getElementById('data-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    categories = JSON.parse(event.target.result);
                    saveCategories();
                    renderCategories();
                    renderNav();
                    alert('数据已从备份还原！');
                } catch (err) {
                    alert('加载失败，无效的JSON文件。');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        function updateOnline() {
            let filename = document.getElementById('update-file-input').value.trim();
            if (!filename) {
                alert('请输入文件名！');
                return;
            }
            if (!filename.endsWith('.json')) {
                filename += '.json';
            }
            fetch(`./${filename}`)
                .then(response => {
                    if (!response.ok) throw new Error('File not found');
                    return response.text();
                })
                .then(data => {
                    categories = JSON.parse(data);
                    saveCategories();
                    renderCategories();
                    renderNav();
                    alert('成功还原！');
                })
                .catch(err => {
                    alert('没有文件！');
                });
        }

        function generateBackupFilename() {
            const now = new Date();
            const timestamp = `${now.getFullYear()}${padZero(now.getMonth() + 1)}${padZero(now.getDate())}-${padZero(now.getHours())}${padZero(now.getMinutes())}${padZero(now.getSeconds())}`;
            return `backup-${timestamp}.json`;
        }

        function padZero(num) {
            return num < 10 ? `0${num}` : num;
        }

        function saveData() {
            const dataStr = JSON.stringify(categories, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const filename = generateBackupFilename();
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            isDataSaved = true;
            saveCategories();
            alert(`数据已保存为 ${filename}！请保存到 HTML 文件目录。`);
        }

        function getFaviconUrl(url) {
            try {
                const urlObj = new URL(url);
                return `${urlObj.origin}/favicon.ico`;
            } catch (e) {
                return 'https://example.com/favicon.ico';
            }
        }

        function moveCategory(id, direction) {
            const index = categories.findIndex(c => c.id === id);
            if (index === -1) return;
            if (direction === 'up' && index > 0) {
                [categories[index], categories[index - 1]] = [categories[index - 1], categories[index]];
            } else if (direction === 'down' && index < categories.length - 1) {
                [categories[index], categories[index + 1]] = [categories[index + 1], categories[index]];
            } else {
                return;
            }
            isDataSaved = false;
            saveCategories();
            renderCategories();
            renderNav();
        }

        function moveSubcategory(catId, subcatId, direction) {
            const cat = categories.find(c => c.id === catId);
            if (!cat) return;
            const subcats = cat.subcategories;
            const index = subcats.findIndex(s => s.id === subcatId);
            if (index === -1) return;
            if (direction === 'up' && index > 0) {
                [subcats[index], subcats[index - 1]] = [subcats[index - 1], subcats[index]];
            } else if (direction === 'down' && index < subcats.length - 1) {
                [subcats[index], subcats[index + 1]] = [subcats[index + 1], subcats[index]];
            } else {
                return;
            }
            isDataSaved = false;
            saveCategories();
            renderCategories();
            renderNav();
        }

        function moveUrl(id, direction) {
            for (const cat of categories) {
                const urlIndex = cat.urls.findIndex(u => u.id === id);
                if (urlIndex !== -1) {
                    if (direction === 'up' && urlIndex > 0) {
                        [cat.urls[urlIndex], cat.urls[urlIndex - 1]] = [cat.urls[urlIndex - 1], cat.urls[urlIndex]];
                    } else if (direction === 'down' && urlIndex < cat.urls.length - 1) {
                        [cat.urls[urlIndex], cat.urls[urlIndex + 1]] = [cat.urls[urlIndex + 1], cat.urls[urlIndex]];
                    } else {
                        return;
                    }
                    isDataSaved = false;
                    saveCategories();
                    renderCategories();
                    return;
                }
                for (const subcat of cat.subcategories) {
                    const subUrlIndex = subcat.urls.findIndex(u => u.id === id);
                    if (subUrlIndex !== -1) {
                        if (direction === 'up' && subUrlIndex > 0) {
                            [subcat.urls[subUrlIndex], subcat.urls[subUrlIndex - 1]] = [subcat.urls[subUrlIndex - 1], subcat.urls[subUrlIndex]];
                        } else if (direction === 'down' && subUrlIndex < subcat.urls.length - 1) {
                            [subcat.urls[subUrlIndex], subcat.urls[subUrlIndex + 1]] = [subcat.urls[subUrlIndex + 1], subcat.urls[subUrlIndex]];
                        } else {
                            return;
                        }
                        isDataSaved = false;
                        saveCategories();
                        renderCategories();
                        return;
                    }
                }
            }
        }

        function getMigrationOptions(excludeCatId) {
            const options = [];
            categories.forEach(cat => {
                if (cat.id === excludeCatId) return;
                options.push({ id: cat.id, name: cat.name, type: 'category' });
                cat.subcategories.forEach(subcat => {
                    options.push({
                        id: subcat.id,
                        name: `${cat.name} > ${subcat.name}`,
                        type: 'subcategory',
                        parentId: cat.id
                    });
                });
            });
            return options;
        }

        function showModal(message, options, onConfirm, onCancel) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <p>${message}</p>
                    <select id="modal-select">
                        <option value="">请选择目标分类</option>
                        ${options.map(opt => `<option value="${opt.id}:${opt.type}:${opt.parentId || ''}">${opt.name}</option>`).join('')}
                    </select>
                    <div class="modal-actions">
                        <button class="modal-confirm">确认</button>
                        <button class="modal-cancel">取消</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            const confirmBtn = modal.querySelector('.modal-confirm');
            const cancelBtn = modal.querySelector('.modal-cancel');
            const select = modal.querySelector('#modal-select');
            confirmBtn.addEventListener('click', () => {
                const selectedValue = select.value;
                if (!selectedValue) {
                    alert('请先选择一个目标分类！');
                    return;
                }
                const [targetId, targetType, parentId] = selectedValue.split(':');
                onConfirm({ id: targetId, type: targetType, parentId });
                document.body.removeChild(modal);
            });
            cancelBtn.addEventListener('click', () => {
                if (onCancel) onCancel();
                document.body.removeChild(modal);
            });
        }

        function migrateUrl(urlId) {
            let url, sourceCat, sourceSubcat;
            for (const cat of categories) {
                const urlIndex = cat.urls.findIndex(u => u.id === urlId);
                if (urlIndex !== -1) {
                    url = cat.urls[urlIndex];
                    sourceCat = cat;
                    sourceSubcat = null;
                    break;
                }
                for (const subcat of cat.subcategories) {
                    const subUrlIndex = subcat.urls.findIndex(u => u.id === urlId);
                    if (subUrlIndex !== -1) {
                        url = subcat.urls[subUrlIndex];
                        sourceCat = cat;
                        sourceSubcat = subcat;
                        break;
                    }
                }
                if (url) break;
            }
            if (!url) {
                alert('未找到该网址！');
                return;
            }
            const options = getMigrationOptions(sourceCat.id);
            if (options.length === 0) {
                alert('没有其他分类可供迁移！');
                return;
            }
            showModal(
                `将网址 "${url.name}" 迁移到以下分类：`,
                options,
                ({ id: targetId, type, parentId }) => {
                    if (type === 'category') {
                        const targetCat = categories.find(c => c.id === targetId);
                        if (sourceSubcat) {
                            sourceSubcat.urls = sourceSubcat.urls.filter(u => u.id !== urlId);
                        } else {
                            sourceCat.urls = sourceCat.urls.filter(u => u.id !== urlId);
                        }
                        targetCat.urls.push(url);
                        alert(`网址 "${url.name}" 已迁移到分类 "${targetCat.name}"！`);
                    } else if (type === 'subcategory') {
                        const targetCat = categories.find(c => c.id === parentId);
                        const targetSubcat = targetCat.subcategories.find(s => s.id === targetId);
                        if (sourceSubcat) {
                            sourceSubcat.urls = sourceSubcat.urls.filter(u => u.id !== urlId);
                        } else {
                            sourceCat.urls = sourceCat.urls.filter(u => u.id !== urlId);
                        }
                        targetSubcat.urls.push(url);
                        alert(`网址 "${url.name}" 已迁移到子分类 "${targetCat.name} > ${targetSubcat.name}"！`);
                    }
                    isDataSaved = false;
                    saveCategories();
                    renderCategories();
                },
                () => {}
            );
        }

        function renderNav() {
            const nav = document.getElementById('nav');
            nav.innerHTML = '';
            categories.forEach(cat => {
                const li = document.createElement('li');
                li.textContent = cat.name;
                li.dataset.catId = cat.id;
                li.addEventListener('click', () => {
                    const target = document.getElementById(cat.id);
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth' });
                    }
                });
                nav.appendChild(li);
                if (cat.subcategories.length) {
                    const subUl = document.createElement('ul');
                    cat.subcategories.forEach(subcat => {
                        const subLi = document.createElement('li');
                        subLi.textContent = subcat.name;
                        subLi.dataset.subcatId = subcat.id;
                        subLi.addEventListener('click', () => {
                            const target = document.getElementById(subcat.id);
                            if (target) {
                                target.scrollIntoView({ behavior: 'smooth' });
                            }
                        });
                        subUl.appendChild(subLi);
                    });
                    nav.appendChild(subUl);
                }
            });
        }

        function renderCategories() {
            const container = document.getElementById('categories');
            const activeElementId = document.activeElement?.id;
            container.innerHTML = '';
            categories.forEach((cat, catIndex) => {
                const catDiv = document.createElement('div');
                catDiv.className = 'category';
                catDiv.id = cat.id;
                catDiv.innerHTML = `
                    <h2>${isEditMode && cat.isEditing ? `<input value="${cat.name}" id="cat-name-${cat.id}" placeholder="分类名称" autocapitalize="off" autocorrect="off">` : cat.name}</h2>
                    <button class="edit-btn ${isEditMode ? '' : 'hidden'}" onclick="toggleEditCategory('${cat.id}')">${cat.isEditing ? '保存' : '修改'}</button>
                    <button class="delete-btn ${isEditMode ? '' : 'hidden'} ${cat.isEditing ? '' : 'disabled'}" onclick="deleteCategory('${cat.id}')">删除</button>
                    <button class="move-btn ${isEditMode ? '' : 'hidden'}" onclick="moveCategory('${cat.id}', 'up')" ${catIndex === 0 ? 'disabled' : ''}>上移</button>
                    <button class="move-btn ${isEditMode ? '' : 'hidden'}" onclick="moveCategory('${cat.id}', 'down')" ${catIndex === categories.length - 1 ? 'disabled' : ''}>下移</button>
                    <div class="urls" id="urls-${cat.id}"></div>
                    <button class="add-btn ${isEditMode ? '' : 'hidden'}" onclick="addUrl('${cat.id}')">添加网址</button>
                    <div id="subcats-${cat.id}"></div>
                    <button class="add-btn ${isEditMode ? '' : 'hidden'}" onclick="addSubcategory('${cat.id}')">添加子分类</button>
                `;
                container.appendChild(catDiv);
                const urlsDiv = catDiv.querySelector(`#urls-${cat.id}`);
                cat.urls.forEach((url, urlIndex) => {
                    const urlDiv = document.createElement('div');
                    urlDiv.className = 'url';
                    urlDiv.innerHTML = `
                        ${isEditMode && url.isEditing ? `
                            <div class="url-main">
                                <div>
                                    <input value="${url.name}" id="url-name-${url.id}" placeholder="名称" autocapitalize="off" autocorrect="off">
                                    <input value="${url.url}" id="url-url-${url.id}" placeholder="网址" autocapitalize="off" autocorrect="off">
                                    <textarea id="url-desc-${url.id}" placeholder="描述" autocapitalize="off" autocorrect="off">${url.desc}</textarea>
                                </div>
                            </div>
                        ` : `
                            <div class="url-main">
                                <a href="${url.url}" target="_blank" class="url-icon-link">
                                    <img src="${url.icon}" alt="favicon" loading="lazy" onerror="this.src='https://example.com/favicon.ico'">
                                </a>
                                <div class="url-content">
                                    <div class="url-name">${url.name}</div>
                                    <div class="url-desc">${url.desc}</div>
                                </div>
                            </div>
                        `}
                        <div class="url-actions ${isEditMode ? '' : 'hidden'}">
                            <button class="edit-btn" onclick="toggleEditUrl('${url.id}')">${url.isEditing ? '保存' : '修改'}</button>
                            <button class="delete-btn ${url.isEditing ? '' : 'disabled'}" onclick="deleteUrl('${url.id}')">删除</button>
                            <button class="move-btn" onclick="moveUrl('${url.id}', 'up')" ${urlIndex === 0 ? 'disabled' : ''}>上移</button>
                            <button class="move-btn" onclick="moveUrl('${url.id}', 'down')" ${urlIndex === cat.urls.length - 1 ? 'disabled' : ''}>下移</button>
                            <button class="migrate-btn" onclick="migrateUrl('${url.id}')">迁移</button>
                        </div>
                    `;
                    urlsDiv.appendChild(urlDiv);
                });
                const subcatsDiv = catDiv.querySelector(`#subcats-${cat.id}`);
                cat.subcategories.forEach((subcat, subcatIndex) => {
                    const subcatDiv = document.createElement('div');
                    subcatDiv.className = 'subcategory';
                    subcatDiv.id = subcat.id;
                    subcatDiv.innerHTML = `
                        <h4>${isEditMode && subcat.isEditing ? `<input value="${subcat.name}" id="subcat-name-${subcat.id}" placeholder="子分类名称" autocapitalize="off" autocorrect="off">` : subcat.name}</h4>
                        <button class="edit-btn ${isEditMode ? '' : 'hidden'}" onclick="toggleEditSubcategory('${subcat.id}')">${subcat.isEditing ? '保存' : '修改'}</button>
                        <button class="delete-btn ${isEditMode ? '' : 'hidden'} ${subcat.isEditing ? '' : 'disabled'}" onclick="deleteSubcategory('${subcat.id}')">删除</button>
                        <button class="move-btn ${isEditMode ? '' : 'hidden'}" onclick="moveSubcategory('${cat.id}', '${subcat.id}', 'up')" ${subcatIndex === 0 ? 'disabled' : ''}>上移</button>
                        <button class="move-btn ${isEditMode ? '' : 'hidden'}" onclick="moveSubcategory('${cat.id}', '${subcat.id}', 'down')" ${subcatIndex === cat.subcategories.length - 1 ? 'disabled' : ''}>下移</button>
                        <div class="urls" id="suburls-${subcat.id}"></div>
                        <button class="add-btn ${isEditMode ? '' : 'hidden'}" onclick="addSubUrl('${subcat.id}')">添加网址</button>
                    `;
                    subcatsDiv.appendChild(subcatDiv);
                    const subUrlsDiv = subcatDiv.querySelector(`#suburls-${subcat.id}`);
                    subcat.urls.forEach((url, urlIndex) => {
                        const urlDiv = document.createElement('div');
                        urlDiv.className = 'url';
                        urlDiv.innerHTML = `
                            ${isEditMode && url.isEditing ? `
                                <div class="url-main">
                                    <div>
                                        <input value="${url.name}" id="url-name-${url.id}" placeholder="名称" autocapitalize="off" autocorrect="off">
                                        <input value="${url.url}" id="url-url-${url.id}" placeholder="网址" autocapitalize="off" autocorrect="off">
                                        <textarea id="url-desc-${url.id}" placeholder="描述" autocapitalize="off" autocorrect="off">${url.desc}</textarea>
                                    </div>
                                </div>
                            ` : `
                                <div class="url-main">
                                    <a href="${url.url}" target="_blank" class="url-icon-link">
                                        <img src="${url.icon}" alt="favicon" loading="lazy" onerror="this.src='https://example.com/favicon.ico'">
                                    </a>
                                    <div class="url-content">
                                        <div class="url-name">${url.name}</div>
                                        <div class="url-desc">${url.desc}</div>
                                    </div>
                                </div>
                            `}
                            <div class="url-actions ${isEditMode ? '' : 'hidden'}">
                                <button class="edit-btn" onclick="toggleEditUrl('${url.id}')">${url.isEditing ? '保存' : '修改'}</button>
                                <button class="delete-btn ${url.isEditing ? '' : 'disabled'}" onclick="deleteUrl('${url.id}')">删除</button>
                                <button class="move-btn" onclick="moveUrl('${url.id}', 'up')" ${urlIndex === 0 ? 'disabled' : ''}>上移</button>
                                <button class="move-btn" onclick="moveUrl('${url.id}', 'down')" ${urlIndex === subcat.urls.length - 1 ? 'disabled' : ''}>下移</button>
                                <button class="migrate-btn" onclick="migrateUrl('${url.id}')">迁移</button>
                            </div>
                        `;
                        subUrlsDiv.appendChild(urlDiv);
                    });
                });
                if (isEditMode && cat.isEditing) {
                    const nameInput = catDiv.querySelector(`#cat-name-${cat.id}`);
                    if (nameInput) {
                        nameInput.addEventListener('input', debounce(() => {
                            cat.name = nameInput.value;
                            isDataSaved = false;
                            saveCategories();
                            renderNav();
                        }, 300));
                    }
                }
            });
            const globalAddBtn = document.querySelector('.content > .add-btn');
            if (globalAddBtn) globalAddBtn.className = `add-btn ${isEditMode ? '' : 'hidden'}`;
            const saveBtn = document.querySelector('.save-btn');
            if (saveBtn) saveBtn.className = `save-btn ${isEditMode ? '' : 'hidden'}`;
            const restoreBtn = document.querySelector('.restore-btn');
            if (restoreBtn) restoreBtn.className = `restore-btn ${isEditMode ? '' : 'hidden'}`;
            const updateInput = document.getElementById('update-file-input');
            if (updateInput) updateInput.className = `${isEditMode ? '' : 'hidden'}`;
            const updateBtn = document.querySelector('.update-btn');
            if (updateBtn) updateBtn.className = `update-btn ${isEditMode ? '' : 'hidden'}`;
            fixMobileKeyboard();
            if (activeElementId) {
                const activeElement = document.getElementById(activeElementId);
                if (activeElement) {
                    activeElement.focus();
                    const value = activeElement.value;
                    activeElement.value = '';
                    activeElement.value = value;
                }
            }
        }

        function toggleMode() {
            if (isEditMode) {
                let hasEditing = false;
                for (const cat of categories) {
                    if (cat.isEditing) {
                        hasEditing = true;
                        break;
                    }
                    if (cat.urls.some(url => url.isEditing)) {
                        hasEditing = true;
                        break;
                    }
                    if (cat.subcategories.some(subcat => subcat.isEditing || subcat.urls.some(url => url.isEditing))) {
                        hasEditing = true;
                        break;
                    }
                }
                if (hasEditing) {
                    alert('退出失败，请先完成编辑！');
                    return;
                }
                if (!isDataSaved) {
                    const saveBtn = document.querySelector('.save-btn');
                    if (saveBtn) {
                        saveBtn.classList.add('blink');
                        setTimeout(() => saveBtn.classList.remove('blink'), 2000); // 移除闪烁类
                    }
                    alert('有未保存的更改！请点击“保存备份”按钮保存后再退出。');
                    return;
                }
                isEditMode = false;
                categories.forEach(cat => {
                    cat.isEditing = false;
                    cat.urls.forEach(url => url.isEditing = false);
                    cat.subcategories.forEach(subcat => {
                        subcat.isEditing = false;
                        subcat.urls.forEach(url => url.isEditing = false);
                    });
                });
                saveCategories();
            } else {
                isEditMode = true;
            }
            const toggleBtn = document.getElementById('toggle-mode');
            if (toggleBtn) toggleBtn.textContent = isEditMode ? '退出' : '进入';
            renderCategories();
            renderNav();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.querySelector('.toggle-sidebar');
            sidebar.classList.toggle('expanded');
            toggleBtn.textContent = sidebar.classList.contains('expanded') ? '▼' : '▲';
            renderNav();
        }

        function generateId(prefix) {
            return `${prefix}-${Date.now()}-${Math.random().toString(36).slice(2, 9)}`;
        }

        function addCategory() {
            categories.push({
                id: generateId('cat'),
                name: '新分类',
                isEditing: false,
                urls: [],
                subcategories: []
            });
            isDataSaved = false;
            saveCategories();
            renderCategories();
            renderNav();
        }

        function toggleEditCategory(id) {
            const cat = categories.find(c => c.id === id);
            if (!cat) return;
            if (cat.isEditing) {
                const nameInput = document.getElementById(`cat-name-${id}`);
                if (nameInput && nameInput.value !== cat.name) {
                    cat.name = nameInput.value;
                    isDataSaved = false;
                }
                cat.isEditing = false;
            } else {
                cat.isEditing = true;
            }
            saveCategories();
            renderCategories();
            renderNav();
        }

        function deleteCategory(id) {
            const cat = categories.find(c => c.id === id);
            if (!cat || !cat.isEditing) return;
            const hasUrls = cat.urls.length > 0;
            const hasSubcategories = cat.subcategories.length > 0;
            const subcatUrls = cat.subcategories.reduce((total, subcat) => total + subcat.urls.length, 0);
            if (hasUrls || hasSubcategories || subcatUrls > 0) {
                const options = getMigrationOptions(cat.id);
                if (options.length === 0) {
                    alert('没有其他分类可供迁移，无法删除！请先创建新分类或清空内容。');
                    return;
                }
                showModal(
                    `分类 "${cat.name}" 包含 ${cat.urls.length + subcatUrls} 个网址和 ${cat.subcategories.length} 个子分类，请选择迁移目标：`,
                    options,
                    ({ id: targetId, type, parentId }) => {
                        if (type === 'category') {
                            const targetCat = categories.find(c => c.id === targetId);
                            targetCat.urls.push(...cat.urls);
                            targetCat.subcategories.push(...cat.subcategories);
                            alert(`分类 "${cat.name}" 的内容已迁移到 "${targetCat.name}" 并删除！`);
                        } else if (type === 'subcategory') {
                            const targetCat = categories.find(c => c.id === parentId);
                            const targetSubcat = targetCat.subcategories.find(s => s.id === targetId);
                            targetSubcat.urls.push(...cat.urls);
                            cat.subcategories.forEach(subcat => {
                                targetSubcat.urls.push(...subcat.urls);
                            });
                            alert(`分类 "${cat.name}" 的所有网址已迁移到子分类 "${targetCat.name} > ${targetSubcat.name}"，其子分类结构已丢弃！`);
                        }
                        categories = categories.filter(c => c.id !== id);
                        isDataSaved = false;
                        saveCategories();
                        renderCategories();
                        renderNav();
                    },
                    () => {
                        alert('必须迁移内容后才能删除分类！');
                    }
                );
            } else {
                if (confirm(`确定要删除分类 "${cat.name}" 吗？`)) {
                    categories = categories.filter(c => c.id !== id);
                    isDataSaved = false;
                    saveCategories();
                    renderCategories();
                    renderNav();
                }
            }
        }

        function addUrl(catId) {
            const cat = categories.find(c => c.id === catId);
            if (!cat) return;
            const newUrl = {
                id: generateId('url'),
                name: '新网站',
                url: 'https://example.com',
                desc: '网站描述',
                icon: getFaviconUrl('https://example.com'),
                isEditing: true
            };
            cat.urls.push(newUrl);
            isDataSaved = false;
            saveCategories();
            renderCategories();
        }

        function toggleEditUrl(id) {
            let url;
            for (const cat of categories) {
                url = cat.urls.find(u => u.id === id);
                if (url) break;
                for (const subcat of cat.subcategories) {
                    url = subcat.urls.find(u => u.id === id);
                    if (url) break;
                }
                if (url) break;
            }
            if (!url) return;
            if (url.isEditing) {
                const nameInput = document.getElementById(`url-name-${id}`);
                const urlInput = document.getElementById(`url-url-${id}`);
                const descInput = document.getElementById(`url-desc-${id}`);
                if (nameInput && urlInput && descInput) {
                    url.name = nameInput.value;
                    url.url = urlInput.value;
                    url.desc = descInput.value;
                    url.icon = getFaviconUrl(url.url);
                    isDataSaved = false;
                }
                url.isEditing = false;
            } else {
                url.isEditing = true;
            }
            saveCategories();
            renderCategories();
            if (url.isEditing) {
                const nameInput = document.getElementById(`url-name-${id}`);
                if (nameInput) nameInput.focus();
            }
        }

        function deleteUrl(id) {
            for (const cat of categories) {
                const urlIndex = cat.urls.findIndex(u => u.id === id);
                if (urlIndex !== -1 && cat.urls[urlIndex].isEditing) {
                    cat.urls.splice(urlIndex, 1);
                    isDataSaved = false;
                    saveCategories();
                    renderCategories();
                    return;
                }
                for (const subcat of cat.subcategories) {
                    const subUrlIndex = subcat.urls.findIndex(u => u.id === id);
                    if (subUrlIndex !== -1 && subcat.urls[subUrlIndex].isEditing) {
                        subcat.urls.splice(subUrlIndex, 1);
                        isDataSaved = false;
                        saveCategories();
                        renderCategories();
                        return;
                    }
                }
            }
        }

        function addSubcategory(catId) {
            const cat = categories.find(c => c.id === catId);
            if (!cat) return;
            cat.subcategories.push({
                id: generateId('subcat'),
                name: '新子分类',
                isEditing: false,
                urls: []
            });
            isDataSaved = false;
            saveCategories();
            renderCategories();
            renderNav();
        }

        function toggleEditSubcategory(id) {
            let subcat;
            for (const cat of categories) {
                subcat = cat.subcategories.find(s => s.id === id);
                if (subcat) break;
            }
            if (!subcat) return;
            if (subcat.isEditing) {
                const nameInput = document.getElementById(`subcat-name-${id}`);
                if (nameInput && nameInput.value !== subcat.name) {
                    subcat.name = nameInput.value;
                    isDataSaved = false;
                }
                subcat.isEditing = false;
            } else {
                subcat.isEditing = true;
            }
            saveCategories();
            renderCategories();
            renderNav();
        }

        function deleteSubcategory(id) {
            for (const cat of categories) {
                const subcatIndex = cat.subcategories.findIndex(s => s.id === id);
                if (subcatIndex !== -1 && cat.subcategories[subcatIndex].isEditing) {
                    cat.subcategories.splice(subcatIndex, 1);
                    isDataSaved = false;
                    saveCategories();
                    renderCategories();
                    renderNav();
                    return;
                }
            }
        }

        function addSubUrl(subcatId) {
            let subcat;
            for (const cat of categories) {
                subcat = cat.subcategories.find(s => s.id === subcatId);
                if (subcat) break;
            }
            if (!subcat) return;
            const newUrl = {
                id: generateId('url'),
                name: '新网站',
                url: 'https://example.com',
                desc: '网站描述',
                icon: getFaviconUrl('https://example.com'),
                isEditing: true
            };
            subcat.urls.push(newUrl);
            isDataSaved = false;
            saveCategories();
            renderCategories();
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        window.addEventListener('resize', debounce(() => {
            renderCategories();
        }, 200));

        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('sidebar');
            if (window.innerWidth <= 767) {
                sidebar.classList.add('expanded');
            }
            renderCategories();
            renderNav();
            fixMobileKeyboard();
        });
    </script>
</body>
</html>