<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>别快导航</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
        }
        .button-group {
            margin: 20px 0;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        #data {
            width: 100%;
            height: 300px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>别快导航</h1>
    <div class="button-group">
        <button id="authorizeBtn" onclick="authorize()">授权管理</button>
        <button id="saveBtn" onclick="onlineSave()" disabled>在线保存</button>
        <button id="autoUpdateBtn" onclick="toggleAutoUpdate()" disabled>自动更新（关）</button>
    </div>
    <textarea id="data" placeholder="在这里输入导航数据（JSON 格式）"></textarea>

    <script>
        let accessToken = localStorage.getItem('access_token') || '';
        let autoUpdateInterval = null;

        // 初始化按钮状态
        updateButtonStates();

        // 授权函数
        function authorize() {
            const clientId = 'YOUR_CLIENT_ID'; // 替换为你的 Client ID
            const repo = 'u788990/u788990.github.io'; // 你的仓库
            const baseUrl = window.location.origin; // 动态获取，例如 https://u788990.github.io
            const redirectUri = 'https://u788990.github.io/callback.html'; // 硬编码，确保匹配 GitHub 设置
            const state = encodeURIComponent(baseUrl);
            const authUrl = `https://github.com/login/oauth/authorize?client_id=${clientId}&scope=repo&redirect_uri=${encodeURIComponent(redirectUri)}&state=${state}`;
            
            console.log('Authorization URL:', authUrl); // 调试用
            
            const popup = window.open(authUrl, 'github-oauth', 'width=600,height=600');
            if (!popup) {
                alert('请允许弹出窗口以完成授权！');
                return;
            }
            window.addEventListener('message', (event) => {
                if (event.origin === baseUrl && event.data.access_token) {
                    accessToken = event.data.access_token;
                    localStorage.setItem('access_token', accessToken);
                    popup.close();
                    updateButtonStates();
                    alert('授权成功！在线保存和自动更新已启用。');
                } else if (event.origin === baseUrl && event.data.error) {
                    alert('授权失败：' + event.data.error);
                    popup.close();
                }
            });
        }

        // 更新按钮状态
        function updateButtonStates() {
            const saveBtn = document.getElementById('saveBtn');
            const autoUpdateBtn = document.getElementById('autoUpdateBtn');
            if (accessToken) {
                saveBtn.disabled = false;
                autoUpdateBtn.disabled = false;
            } else {
                saveBtn.disabled = true;
                autoUpdateBtn.disabled = true;
                if (autoUpdateInterval) {
                    clearInterval(autoUpdateInterval);
                    autoUpdateInterval = null;
                    autoUpdateBtn.textContent = '自动更新（关）';
                }
            }
        }

        // 在线保存
        async function onlineSave() {
            const data = document.getElementById('data').value;
            try {
                JSON.parse(data); // 验证 JSON 格式
            } catch (e) {
                alert('数据格式错误，请输入有效的 JSON！');
                return;
            }

            const filePath = 'biekuai.json';
            const message = 'Update biekuai.json via web app';
            const content = btoa(unescape(encodeURIComponent(data))); // Base64 编码

            try {
                // 获取当前文件内容（如果存在）
                const getFileRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `token ${accessToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                const getFileData = await getFileRes.json();

                // 更新文件
                const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${accessToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        message,
                        content,
                        sha: getFileData.sha // 需要文件的 SHA 用于更新
                    })
                });

                if (updateRes.ok) {
                    alert('保存成功！');
                } else {
                    const errorData = await updateRes.json();
                    alert('保存失败：' + (errorData.message || '未知错误'));
                }
            } catch (e) {
                // 如果文件不存在，创建新文件
                if (e.message.includes('404')) {
                    const createRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${accessToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify({
                            message,
                            content
                        })
                    });

                    if (createRes.ok) {
                        alert('保存成功！');
                    } else {
                        const errorData = await createRes.json();
                        alert('保存失败：' + (errorData.message || '未知错误'));
                    }
                } else {
                    alert('保存失败：' + e.message);
                }
            }
        }

        // 切换自动更新
        function toggleAutoUpdate() {
            const autoUpdateBtn = document.getElementById('autoUpdateBtn');
            if (autoUpdateInterval) {
                clearInterval(autoUpdateInterval);
                autoUpdateInterval = null;
                autoUpdateBtn.textContent = '自动更新（关）';
                alert('自动更新已关闭');
            } else {
                autoUpdateInterval = setInterval(() => {
                    onlineSave();
                }, 300000); // 每 5 分钟保存一次
                autoUpdateBtn.textContent = '自动更新（开）';
                alert('自动更新已开启，每 5 分钟保存一次');
                onlineSave(); // 立即保存一次
            }
        }

        // 加载现有数据（可选）
        async function loadData() {
            if (!accessToken) return;
            const filePath = 'biekuai.json';
            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `token ${accessToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                if (res.ok) {
                    const data = await res.json();
                    const content = decodeURIComponent(escape(atob(data.content)));
                    document.getElementById('data').value = content;
                }
            } catch (e) {
                console.log('加载数据失败：', e.message);
            }
        }

        // 页面加载时尝试加载数据
        if (accessToken) {
            loadData();
        }
    </script>
</body>
</html>